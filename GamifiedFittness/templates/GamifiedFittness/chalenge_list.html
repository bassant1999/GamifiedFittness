{% extends "GamifiedFittness/layout.html" %}

{% block head %}
{% endblock %}

{% block header %} 
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h1 class="header">Challenges</h1>
        <button type="button" class="btn btn-outline-secondary m-lg-3" data-bs-toggle="modal" data-bs-target="#addChallenge">
            + Challenge
        </button>
    </div>
{% endblock %}

{% block modal %}
    <div class="modal fade" id="addChallenge" tabindex="-1" aria-labelledby="addChallengeModal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addChallengeModal">Add Chalenge</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="response-message" class="alert d-none"></div>

                    <form id="chalenge-add-form">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="name">Name</label>
                                    <input type="text" class="form-control" id="name" name="name" placeholder="Name" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="calories">Calories</label>
                                    <input type="number" class="form-control" id="calories" name="calories" placeholder="Calories" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="points">Points</label>
                                    <input type="number" class="form-control" id="points" name="points" placeholder="Points" required>
                                </div>
                            </div>
                        </div>
                       
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="description">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="3" placeholder="Description"></textarea>
                                  </div>
                            </div>
                        </div>
                
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="start_date">Start Date</label>
                                    <input type="date" class="form-control" id="start_date" name="start_date" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="end_date">End Date</label>
                                    <input type="date" class="form-control" id="end_date" name="end_date" required>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Save</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="joinChallenge" tabindex="-1" aria-labelledby="addChallengeModal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addChallengeModal">Join Chalenge</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="response-message" class="alert d-none"></div>
                    <i class="fa-solid fa-copy"></i>
                    <i class="fa-solid fa-share-from-square"></i>
                    <form id="chalenge-add-form">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="name">Name</label>
                                    <input type="text" class="form-control" id="name" name="name" placeholder="Name" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="calories">Calories</label>
                                    <input type="number" class="form-control" id="calories" name="calories" placeholder="Calories" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="points">Points</label>
                                    <input type="number" class="form-control" id="points" name="points" placeholder="Points" required>
                                </div>
                            </div>
                        </div>
                       
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="description">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="3" placeholder="Description"></textarea>
                                  </div>
                            </div>
                        </div>
                
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="start_date">Start Date</label>
                                    <input type="date" class="form-control" id="start_date" name="start_date" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="end_date">End Date</label>
                                    <input type="date" class="form-control" id="end_date" name="end_date" required>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Save</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block body %}
    <div class="border-light card m-4">
        <div class="d-flex justify-content-between mt-4">

            {% if chalenges.has_previous %}
                <a href="?page={{ chalenges.previous_page_number }}" class="btn btn-primary">
                    &larr; Previous
                </a>
            {% else %}
                <a class="btn btn-secondary disabled" aria-disabled="true">
                    &larr; Previous
                </a>
            {% endif %}
            {% if chalenges.has_next %}
                <a href="?page={{ chalenges.next_page_number }}" class="btn btn-primary">
                    Next &rarr;
                </a>
            {% else %}
                <a class="btn btn-secondary disabled" aria-disabled="true">
                    Next &rarr;
                </a>
            {% endif %}
        </div>
        
        {% if chalenges|length > 0 %}
            <div class="card-body">
                <div class="d-flex flex-wrap">
                    {% for chalenge in chalenges %}
                        <div class="card me-5 mb-5" style="width:fit-content">
                            <div class="card-header d-flex align-items-center justify-content-between">
                                <h4> 
                                    <i class="fas fa-trophy text-primary"></i>
                                    {{ chalenge.name }} 
                                </h4> 
                                <button type="button" class="btn btn-primary ms-auto ms-lg-3" data-bs-toggle="modal" data-bs-target="#joinChallenge">
                                    Join
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <span class="me-3"><i class="fas fa-fire" style="color: gold;"></i> {{ chalenge.calories }} Cal</span>
                                    <span class="me-3"><i class="fas fa-star" style="color: gold;"></i> {{ chalenge.points }} Pts</span>
                                </div>
                                {% if chalenge.description %}
                                    <p class="card-text">
                                        <i class="fas fa-info-circle"></i> {{ chalenge.description }}
                                    </p>
                                {% endif %}
                                <p class="card-text d-flex justify-content-end mt-4"> 
                                    <small class="text-muted"> <i class="fas fa-calendar-alt"></i> {{ chalenge.start_date }} </small>
                                    &nbsp; to &nbsp; 
                                    <small class=" text-muted"> <i class="fas fa-calendar-alt"></i> {{ chalenge.end_date }} </small></p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <div class="alert alert-warning m" role="alert">
                <i class="fa-solid fa-triangle-exclamation"></i> No Chalenges Yet
            </div>
        {% endif %}
    </div>
   
{% endblock %}

{% block script %}
    <script>

        document.getElementById('chalenge-add-form').addEventListener('submit', async function (event) {
            
            event.preventDefault(); 

            const form = event.target;
            const formData = new FormData(form);
            const responseMessage = document.getElementById('response-message');

            try {
                const response = await fetch("{% url 'add_chalenge' %}", {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    responseMessage.classList.remove('d-none', 'alert-success');
                    responseMessage.classList.add('alert-danger');
                    responseMessage.innerText = data.error || 'An error occurred.';
                } 
                window.location.href = '{% url "list_chalenge" %}';
            } catch (error) {
                responseMessage.classList.remove('d-none', 'alert-success');
                responseMessage.classList.add('alert-danger');
                responseMessage.innerText = 'An unexpected error occurred.';
                console.error('Error:', error);
            }
        });


    </script>
{% endblock %}

<div id="chalengeContainer"></div>
